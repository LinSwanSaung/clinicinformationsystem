{
  "generated": "2025-11-03",
  "purpose": "Complete inventory of database objects and their usage in codebase",
  "database": "PostgreSQL (Supabase)",

  "tables": {
    "users": {
      "schema": "backend/database/schema.sql:13-34",
      "columns": [
        "id",
        "email",
        "password_hash",
        "first_name",
        "last_name",
        "phone",
        "role",
        "specialty",
        "license_number",
        "is_active",
        "patient_id",
        "last_login",
        "created_at",
        "updated_at",
        "deleted_at"
      ],
      "constraints": ["valid_role", "valid_email"],
      "usage": {
        "models": ["backend/src/models/User.model.js"],
        "services": ["backend/src/services/Auth.service.js"],
        "frontend": [
          "frontend/src/services/authService.js",
          "frontend/src/services/userService.js",
          "frontend/src/services/employeeService.js"
        ],
        "note": "Central authentication table - links to patients via patient_id for portal users"
      }
    },

    "patients": {
      "schema": "backend/database/schema.sql:41-70",
      "columns": [
        "id",
        "patient_number",
        "first_name",
        "last_name",
        "date_of_birth",
        "gender",
        "phone",
        "email",
        "address",
        "emergency_contact_name",
        "emergency_contact_phone",
        "emergency_contact_relationship",
        "blood_group",
        "allergies",
        "medical_conditions",
        "current_medications",
        "insurance_provider",
        "insurance_number",
        "registration_date",
        "is_active",
        "created_at",
        "updated_at"
      ],
      "constraints": ["valid_gender", "valid_blood_group", "valid_age"],
      "usage": {
        "models": ["backend/src/models/Patient.model.js"],
        "services": ["backend/src/services/Patient.service.js"],
        "frontend": [
          "frontend/src/services/patientService.js",
          "frontend/src/pages/receptionist/RegisterPatient.jsx",
          "frontend/src/pages/receptionist/PatientDetailPage.jsx",
          "frontend/src/pages/receptionist/PatientListPage.jsx",
          "frontend/src/components/ReceptionistPatientCard.jsx",
          "frontend/src/components/medical/PatientCard.jsx"
        ],
        "note": "Core patient demographics - denormalized fields (allergies, medical_conditions) coexist with normalized tables"
      }
    },

    "appointments": {
      "schema": "backend/database/schema.sql:73-105",
      "columns": [
        "id",
        "patient_id",
        "doctor_id",
        "appointment_date",
        "appointment_time",
        "duration_minutes",
        "appointment_type",
        "reason_for_visit",
        "status",
        "notes",
        "created_by",
        "created_at",
        "updated_at",
        "resolved_by_admin",
        "resolved_reason"
      ],
      "constraints": ["valid_status", "valid_duration"],
      "statuses": [
        "scheduled",
        "waiting",
        "ready_for_doctor",
        "consulting",
        "completed",
        "cancelled",
        "no_show",
        "late"
      ],
      "usage": {
        "models": ["backend/src/models/Appointment.model.js"],
        "services": ["backend/src/services/Appointment.service.js"],
        "routes": ["backend/src/routes/appointment.routes.js"],
        "frontend": [
          "frontend/src/services/appointmentService.js",
          "frontend/src/pages/receptionist/AppointmentsPage.jsx",
          "frontend/src/pages/receptionist/ReceptionistDashboard.jsx",
          "frontend/src/pages/doctor/DoctorDashboard.jsx",
          "frontend/src/components/AppointmentCard.jsx",
          "frontend/src/components/AppointmentList.jsx",
          "frontend/src/components/WalkInModal.jsx"
        ],
        "note": "Appointment booking and lifecycle management - integrates with queue_tokens"
      }
    },

    "visits": {
      "schema": "backend/database/schema.sql:108-132",
      "columns": [
        "id",
        "patient_id",
        "doctor_id",
        "visit_date",
        "visit_type",
        "reason_for_visit",
        "diagnosis",
        "treatment_plan",
        "follow_up_date",
        "status",
        "created_at",
        "updated_at",
        "start_time",
        "end_time"
      ],
      "statuses": ["in_progress", "completed", "cancelled"],
      "usage": {
        "models": ["backend/src/models/Visit.model.js"],
        "services": ["backend/src/services/Visit.service.js"],
        "routes": ["backend/src/routes/medicalRecord.routes.js"],
        "frontend": [
          "frontend/src/services/visitService.js",
          "frontend/src/pages/doctor/PatientMedicalRecord.jsx",
          "frontend/src/pages/doctor/PatientMedicalRecordManagement.jsx",
          "frontend/src/pages/nurse/ElectronicMedicalRecords.jsx",
          "frontend/src/pages/patient/PatientMedicalRecords.jsx",
          "frontend/src/components/medical/VisitHistoryCard.jsx"
        ],
        "note": "EMR core - aggregates vitals, prescriptions, diagnoses, notes per consultation"
      }
    },

    "vitals": {
      "schema": "backend/database/schema.sql:135-169",
      "columns": [
        "id",
        "visit_id",
        "patient_id",
        "systolic_bp",
        "diastolic_bp",
        "heart_rate",
        "temperature",
        "respiratory_rate",
        "oxygen_saturation",
        "height",
        "weight",
        "bmi",
        "notes",
        "recorded_by",
        "recorded_at",
        "created_at",
        "updated_at",
        "priority"
      ],
      "usage": {
        "services": ["backend/src/services/Visit.service.js"],
        "frontend": [
          "frontend/src/services/vitalsService.js",
          "frontend/src/pages/nurse/NurseDashboard.jsx",
          "frontend/src/pages/doctor/PatientMedicalRecord.jsx",
          "frontend/src/components/patient/VitalsSnapshot.jsx",
          "frontend/src/components/medical/PatientVitalsDisplay.jsx"
        ],
        "note": "Nurse records vitals before doctor consultation - priority field added in migration"
      }
    },

    "prescriptions": {
      "schema": "backend/database/schema.sql:172-197",
      "columns": [
        "id",
        "visit_id",
        "patient_id",
        "medication_name",
        "dosage",
        "frequency",
        "duration",
        "quantity",
        "instructions",
        "prescribed_by",
        "prescribed_date",
        "status",
        "filled_date",
        "pharmacy_notes",
        "created_at",
        "updated_at"
      ],
      "statuses": ["active", "completed", "cancelled"],
      "usage": {
        "models": ["backend/src/models/Prescription.model.js"],
        "services": ["backend/src/services/Prescription.service.js"],
        "frontend": [
          "frontend/src/services/prescriptionService.js",
          "frontend/src/pages/doctor/PatientMedicalRecord.jsx",
          "frontend/src/pages/cashier/CashierDashboard.jsx",
          "frontend/src/components/medical/forms/PrescriptionForm.jsx"
        ],
        "note": "Doctor prescribes - Cashier/Pharmacist fulfills - Links to invoices for billing"
      }
    },

    "doctor_notes": {
      "schema": "backend/database/schema.sql:200-214",
      "columns": [
        "id",
        "visit_id",
        "patient_id",
        "doctor_id",
        "note_type",
        "content",
        "is_confidential",
        "created_at",
        "updated_at"
      ],
      "usage": {
        "models": ["backend/src/models/DoctorNote.model.js"],
        "services": ["backend/src/services/DoctorNote.service.js"],
        "frontend": [
          "frontend/src/services/doctorNotesService.js",
          "frontend/src/pages/doctor/PatientMedicalRecord.jsx",
          "frontend/src/components/medical/forms/DoctorNotesForm.jsx",
          "frontend/src/components/medical/ClinicalNotesDisplay.jsx"
        ],
        "note": "Free-form clinical notes by doctors - can be confidential"
      }
    },

    "medical_documents": {
      "schema": "backend/database/schema.sql:217-235",
      "columns": [
        "id",
        "patient_id",
        "visit_id",
        "document_type",
        "document_name",
        "file_path",
        "file_size",
        "mime_type",
        "uploaded_by",
        "uploaded_at",
        "created_at",
        "updated_at"
      ],
      "usage": {
        "services": ["backend/src/services/Document.service.js"],
        "routes": ["backend/src/routes/document.routes.js"],
        "frontend": [
          "frontend/src/services/documentService.js",
          "frontend/src/components/medical/PatientDocumentManager.jsx"
        ],
        "note": "DEPRECATED - Replaced by patient_documents table in migrations"
      }
    },

    "audit_logs": {
      "schema": "backend/database/schema.sql:238-286",
      "columns": [
        "id",
        "user_id",
        "action",
        "entity_type",
        "entity_id",
        "old_values",
        "new_values",
        "ip_address",
        "user_agent",
        "created_at",
        "admin_override",
        "override_reason"
      ],
      "usage": {
        "utils": ["backend/src/utils/auditLogger.js"],
        "services": ["backend/src/services/AuditLog.service.js"],
        "routes": ["backend/src/routes/auditLog.routes.js"],
        "frontend": [
          "frontend/src/services/auditLogService.js",
          "frontend/src/pages/admin/AuditLogs.jsx"
        ],
        "note": "Comprehensive audit trail - user_id made nullable in migration 007"
      }
    },

    "doctor_availability": {
      "schema": "backend/database/schema.sql:289-304",
      "columns": [
        "id",
        "doctor_id",
        "day_of_week",
        "start_time",
        "end_time",
        "is_available",
        "max_appointments",
        "slot_duration",
        "created_at",
        "updated_at"
      ],
      "usage": {
        "models": ["backend/src/models/DoctorAvailability.model.js"],
        "services": ["backend/src/services/DoctorAvailability.service.js"],
        "routes": ["backend/src/routes/doctorAvailability.routes.js"],
        "frontend": [
          "frontend/src/services/doctorAvailabilityService.js",
          "frontend/src/pages/admin/DoctorAvailability.jsx",
          "frontend/src/pages/receptionist/AppointmentsPage.jsx"
        ],
        "note": "Weekly schedule templates - Used for appointment slot calculation"
      }
    },

    "queue_tokens": {
      "schema": "backend/database/schema.sql:307-371",
      "columns": [
        "id",
        "patient_id",
        "doctor_id",
        "appointment_id",
        "token_number",
        "priority",
        "status",
        "checked_in_at",
        "called_at",
        "consultation_started_at",
        "consultation_ended_at",
        "estimated_wait_time",
        "actual_wait_time",
        "notes",
        "created_at",
        "updated_at",
        "visit_id",
        "delayed_until",
        "is_delayed"
      ],
      "statuses": [
        "waiting",
        "called",
        "in_consultation",
        "completed",
        "cancelled",
        "no_show",
        "delayed"
      ],
      "usage": {
        "models": ["backend/src/models/QueueToken.model.js"],
        "services": ["backend/src/services/Queue.service.js"],
        "routes": ["backend/src/routes/queue.routes.js"],
        "frontend": [
          "frontend/src/services/queueService.js",
          "frontend/src/pages/receptionist/LiveQueuePage.jsx",
          "frontend/src/pages/receptionist/DoctorQueueDetailPage.jsx",
          "frontend/src/pages/doctor/DoctorDashboard.jsx",
          "frontend/src/pages/nurse/NurseDashboard.jsx",
          "frontend/src/pages/patient/PatientLiveQueue.jsx",
          "frontend/src/components/QueueDoctorCard.jsx"
        ],
        "note": "Real-time queue management - Critical for workflow - visit_id added in migration 002"
      }
    },

    "clinic_settings": {
      "schema": "backend/database/schema.sql:374-381",
      "columns": [
        "id",
        "setting_key",
        "setting_value",
        "description",
        "created_at",
        "updated_at"
      ],
      "usage": {
        "services": ["backend/src/services/ClinicSettings.service.js"],
        "routes": ["backend/src/routes/clinicSettings.routes.js"],
        "frontend": [
          "frontend/src/services/clinicSettingsService.js",
          "frontend/src/pages/receptionist/AppointmentsPage.jsx",
          "frontend/src/pages/patient/PatientLiveQueue.jsx",
          "frontend/src/utils/appointmentConfig.js"
        ],
        "note": "Key-value config store - consultation_duration_minutes, late_threshold_minutes"
      }
    },

    "patient_allergies": {
      "schema": "backend/database/schema.sql:1465-1505",
      "added_in": "migration 001_emr_enhancements.sql",
      "columns": [
        "id",
        "patient_id",
        "allergy_name",
        "allergy_type",
        "severity",
        "reaction",
        "diagnosed_date",
        "notes",
        "is_active",
        "recorded_by",
        "created_at",
        "updated_at",
        "visit_id"
      ],
      "usage": {
        "models": ["backend/src/models/PatientAllergy.model.js"],
        "services": ["backend/src/services/PatientAllergy.service.js"],
        "routes": ["backend/src/routes/patientAllergy.routes.js"],
        "frontend": [
          "frontend/src/services/allergyService.js",
          "frontend/src/pages/doctor/PatientMedicalRecord.jsx",
          "frontend/src/pages/doctor/PatientMedicalRecordManagement.jsx",
          "frontend/src/components/medical/forms/AllergyForm.jsx"
        ],
        "note": "Normalized allergy tracking - visit_id added in migration 004"
      }
    },

    "patient_diagnoses": {
      "schema": "backend/database/schema.sql:1508-1567",
      "added_in": "migration 001_emr_enhancements.sql",
      "columns": [
        "id",
        "patient_id",
        "diagnosis_name",
        "diagnosis_code",
        "category",
        "severity",
        "status",
        "diagnosed_date",
        "resolved_date",
        "notes",
        "diagnosed_by",
        "created_at",
        "updated_at",
        "icd_10_code"
      ],
      "usage": {
        "models": ["backend/src/models/PatientDiagnosis.model.js"],
        "services": ["backend/src/services/PatientDiagnosis.service.js"],
        "routes": ["backend/src/routes/patientDiagnosis.routes.js"],
        "frontend": [
          "frontend/src/services/diagnosisService.js",
          "frontend/src/pages/doctor/PatientMedicalRecord.jsx",
          "frontend/src/pages/doctor/PatientMedicalRecordManagement.jsx",
          "frontend/src/components/medical/forms/DiagnosisForm.jsx"
        ],
        "note": "ICD-10 diagnosis tracking - category added in migration 005, icd_10_code in migration 007"
      }
    },

    "patient_documents": {
      "schema": "backend/database/schema.sql:1570-1598",
      "added_in": "migration 004_create_patient_documents_table.sql",
      "columns": [
        "id",
        "patient_id",
        "visit_id",
        "document_type",
        "document_name",
        "file_url",
        "file_size",
        "mime_type",
        "uploaded_by",
        "created_at",
        "updated_at"
      ],
      "usage": {
        "services": ["backend/src/services/Document.service.js"],
        "routes": ["backend/src/routes/document.routes.js"],
        "frontend": [
          "frontend/src/services/documentService.js",
          "frontend/src/components/medical/PatientDocumentManager.jsx",
          "frontend/src/pages/doctor/PatientMedicalRecordManagement.jsx"
        ],
        "note": "Replaces medical_documents - Uses Supabase Storage for file_url"
      }
    },

    "services": {
      "schema": "backend/database/schema.sql:1900-1915",
      "added_in": "migration 003_billing_system.sql",
      "columns": [
        "id",
        "service_code",
        "service_name",
        "description",
        "category",
        "price",
        "is_active",
        "created_at",
        "updated_at"
      ],
      "usage": {
        "models": ["backend/src/models/Service.model.js"],
        "services": ["backend/src/services/Service.service.js"],
        "frontend": [
          "frontend/src/services/serviceService.js",
          "frontend/src/components/ServiceSelector.jsx",
          "frontend/src/pages/cashier/CashierDashboard.jsx"
        ],
        "note": "Billable services catalog - Used in invoice line items"
      }
    },

    "invoices": {
      "schema": "backend/database/schema.sql:1918-1955",
      "added_in": "migration 003_billing_system.sql",
      "columns": [
        "id",
        "invoice_number",
        "visit_id",
        "patient_id",
        "issued_date",
        "due_date",
        "status",
        "subtotal",
        "tax",
        "discount",
        "total_amount",
        "notes",
        "created_by",
        "created_at",
        "updated_at",
        "on_hold",
        "hold_reason",
        "hold_until"
      ],
      "statuses": [
        "draft",
        "pending",
        "paid",
        "partially_paid",
        "cancelled",
        "overdue"
      ],
      "usage": {
        "models": ["backend/src/models/Invoice.model.js"],
        "services": ["backend/src/services/Invoice.service.js"],
        "routes": ["backend/src/routes/invoice.routes.js"],
        "frontend": [
          "frontend/src/services/invoiceService.js",
          "frontend/src/pages/cashier/CashierDashboard.jsx",
          "frontend/src/pages/cashier/InvoiceManagement.jsx",
          "frontend/src/pages/InvoiceDetailsPage.jsx",
          "frontend/src/pages/admin/PaymentTransactions.jsx"
        ],
        "note": "Billing core - on_hold fields added in migration 002_payment_holds.sql"
      }
    },

    "invoice_items": {
      "schema": "backend/database/schema.sql:1958-1983",
      "added_in": "migration 003_billing_system.sql",
      "columns": [
        "id",
        "invoice_id",
        "service_id",
        "description",
        "quantity",
        "unit_price",
        "line_total",
        "created_at",
        "updated_at"
      ],
      "usage": {
        "models": ["backend/src/models/InvoiceItem.model.js"],
        "services": ["backend/src/services/Invoice.service.js"],
        "frontend": [
          "frontend/src/services/invoiceService.js",
          "frontend/src/pages/cashier/CashierDashboard.jsx",
          "frontend/src/pages/InvoiceDetailsPage.jsx"
        ],
        "note": "Invoice line items - Links to services table"
      }
    },

    "payment_transactions": {
      "schema": "backend/database/schema.sql:1986-2078",
      "added_in": "migration 003_billing_system.sql",
      "columns": [
        "id",
        "invoice_id",
        "payment_date",
        "amount",
        "payment_method",
        "payment_reference",
        "status",
        "processed_by",
        "notes",
        "created_at",
        "updated_at"
      ],
      "statuses": ["pending", "completed", "failed", "refunded"],
      "usage": {
        "models": ["backend/src/models/PaymentTransaction.model.js"],
        "services": ["backend/src/services/Payment.service.js"],
        "frontend": [
          "frontend/src/services/paymentService.js",
          "frontend/src/pages/cashier/CashierDashboard.jsx",
          "frontend/src/pages/admin/PaymentTransactions.jsx"
        ],
        "note": "Payment tracking - Multiple tables with same name exist (consolidation needed)"
      }
    },

    "notifications": {
      "schema": "backend/database/schema.sql:2122-2141",
      "added_in": "migration 004_notifications.sql",
      "columns": [
        "id",
        "user_id",
        "title",
        "message",
        "type",
        "is_read",
        "created_at",
        "read_at"
      ],
      "types": ["info", "warning", "error", "success"],
      "usage": {
        "models": ["backend/src/models/Notification.model.js"],
        "services": ["backend/src/services/Notification.service.js"],
        "routes": ["backend/src/routes/notification.routes.js"],
        "frontend": [
          "frontend/src/services/notificationService.js",
          "frontend/src/components/NotificationBell.jsx"
        ],
        "note": "In-app notification system - Real-time updates needed"
      }
    }
  },

  "views": {
    "note": "No views currently defined - Potential candidates: active_patients, today_appointments, pending_invoices"
  },

  "enums": {
    "queue_token_state": {
      "defined_in": "backend/database/v2schema.sql:63-65",
      "values": [
        "SCHEDULED",
        "WAITING_SCHEDULED",
        "WAITING",
        "READY",
        "IN_CONSULT",
        "DONE",
        "LATE",
        "NO_SHOW",
        "CANCELLED"
      ],
      "usage": ["queue_tokens_v2 table (v2schema)"],
      "note": "V2 queue system - Not yet migrated to main schema"
    },

    "queue_priority": {
      "defined_in": "backend/database/v2schema.sql:69",
      "values": ["Normal", "Emergency"],
      "usage": [
        "queue_tokens_v2 table (v2schema)",
        "vitals table (priority column added separately)"
      ],
      "note": "Used in V2 queue and vitals priority system"
    }
  },

  "functions": {
    "note": "No custom PostgreSQL functions defined - All logic in application layer"
  },

  "policies": {
    "rls_enabled": true,
    "generic_policies": [
      {
        "name": "Healthcare staff can access all data",
        "applies_to": [
          "users",
          "patients",
          "appointments",
          "visits",
          "vitals",
          "prescriptions",
          "doctor_notes",
          "medical_documents",
          "doctor_availability",
          "queue_tokens",
          "clinic_settings",
          "services",
          "invoices",
          "invoice_items",
          "payment_transactions"
        ],
        "rule": "FOR ALL USING (true)",
        "note": "Permissive - Should be refined based on role"
      },
      {
        "name": "Admins can access audit logs",
        "applies_to": ["audit_logs"],
        "rule": "FOR ALL USING (true)",
        "note": "Admin-only access"
      }
    ],

    "specific_policies": [
      {
        "table": "patient_allergies",
        "policies": [
          "Allow authenticated users to read allergies",
          "Allow doctors and nurses to insert allergies",
          "Allow doctors and nurses to update allergies"
        ]
      },
      {
        "table": "patient_diagnoses",
        "policies": [
          "Allow authenticated users to read diagnoses",
          "Allow doctors to insert diagnoses",
          "Allow doctors to update diagnoses"
        ]
      },
      {
        "table": "patient_documents",
        "policies": [
          "Allow authenticated users to read documents",
          "Allow authenticated users to upload documents",
          "Allow admins and doctors to delete documents"
        ]
      },
      {
        "table": "notifications",
        "policies": [
          "Users can view own notifications",
          "System can create notifications",
          "Users can update own notifications"
        ]
      },
      {
        "table": "payment_transactions",
        "policies": [
          "Users can view payment transactions",
          "Cashiers can create payment transactions",
          "Admins can update payment transactions"
        ]
      }
    ],

    "issues": [
      "Generic 'true' policies bypass RLS - Security risk",
      "No patient portal restrictions - Patients can see all data via generic policy",
      "Doctor/Nurse role checks not enforced at DB level"
    ]
  },

  "rpc_calls": {
    "exec_sql": {
      "found_in": [
        "backend/fix_payment_table.js:32",
        "APPOINTMENT_QUEUE_DELAY_IMPLEMENTATION.md:92"
      ],
      "usage": "Ad-hoc SQL execution",
      "note": "Dangerous - Direct SQL execution"
    },

    "exec": {
      "found_in": ["backend/run_payment_migration.js:57"],
      "usage": "Migration execution",
      "note": "Similar to exec_sql"
    },

    "note": "No custom RPC functions defined - Potential use cases: complex aggregations, report generation"
  },

  "indexes": {
    "note": "Indexes not explicitly documented in schema files - Should audit production DB for actual indexes",
    "recommended": [
      "patients.patient_number (UNIQUE - likely exists)",
      "appointments.doctor_id, appointment_date (composite for queries)",
      "queue_tokens.doctor_id, status (composite for active queue)",
      "visits.patient_id, created_at (for history queries)",
      "audit_logs.user_id, created_at (for audit trails)",
      "invoices.patient_id, status (for pending invoices)",
      "notifications.user_id, is_read (for unread count)"
    ]
  },

  "triggers": {
    "updated_at_triggers": {
      "note": "Most tables have updated_at columns - Triggers likely exist but not in schema.sql",
      "recommendation": "Document all triggers or migrate to application-level timestamp management"
    }
  },

  "migrations": {
    "total_files": 26,
    "issues": [
      "Duplicate prefixes (002_* appears 6 times)",
      "No consolidated baseline after migrations",
      "Some migrations modify same tables (payment_transactions has 3 definitions)",
      "No migration rollback scripts"
    ],
    "files": [
      "001_emr_enhancements.sql",
      "002_add_admin_override_columns.sql",
      "002_add_cashier_pharmacist_roles.sql",
      "002_add_delayed_status.sql",
      "002_add_priority_to_vitals.sql",
      "002_add_visit_id_to_queue_tokens.sql",
      "002_payment_holds.sql",
      "002_quick_fix.sql",
      "003_add_delayed_status_appointment_queue.sql",
      "003_add_visit_times.sql",
      "003_billing_system.sql",
      "003_enhance_audit_logs.sql",
      "004_add_action_constraint.sql",
      "004_add_visit_id_to_allergies.sql",
      "004_add_visit_id_to_queue_tokens.sql",
      "004_create_patient_documents_table.sql",
      "004_notifications.sql",
      "005_add_category_to_diagnoses.sql",
      "005_add_invoice_actions.sql",
      "005_add_late_status.sql",
      "005_cleanup_appointment_queue.sql",
      "005_doctor_unavailability_management.sql",
      "006_add_diagnosis_date_to_diagnoses.sql",
      "006_extend_audit_logs_actions.sql",
      "007_add_icd_10_code_to_diagnoses.sql",
      "007_make_audit_logs_user_id_nullable.sql",
      "008_add_patient_portal_accounts.sql",
      "009_add_admin_override_columns.sql"
    ]
  },

  "usage_statistics": {
    "total_tables": 20,
    "total_models": 15,
    "total_services": 18,
    "total_frontend_service_files": 24,
    "direct_supabase_calls": 11,
    "most_referenced_table": "queue_tokens (10+ frontend components)",
    "least_referenced_table": "clinic_settings (3 files)"
  },

  "risks": {
    "high": [
      "Multiple schema sources (schema.sql, v2schema.sql, 26 migrations) - No single source of truth",
      "RLS policies too permissive - All authenticated users can access all data",
      "No indexes documented - Performance concerns",
      "Direct RPC exec_sql usage - SQL injection risk"
    ],
    "medium": [
      "Duplicate table definitions (payment_transactions x3)",
      "Denormalized fields alongside normalized tables (patient allergies)",
      "No database-level role checks (role validation only in app)",
      "Missing foreign key cascades documented"
    ],
    "low": [
      "No views defined - Complex queries repeated in code",
      "No custom functions - All business logic in app layer",
      "Trigger documentation incomplete"
    ]
  },

  "recommendations": {
    "immediate": [
      "Consolidate schema.sql + v2schema.sql + migrations into single baseline",
      "Audit and restrict RLS policies by role",
      "Document all indexes in production",
      "Remove or secure exec_sql RPC calls"
    ],
    "short_term": [
      "Create database views for common queries (active patients, pending invoices)",
      "Add composite indexes for queue and appointment queries",
      "Implement proper foreign key cascades",
      "Rename migrations with timestamp prefixes"
    ],
    "long_term": [
      "Consider stored procedures for complex workflows (queue management)",
      "Implement database-level audit triggers",
      "Setup automated schema documentation",
      "Create migration rollback scripts"
    ]
  }
}
